version: "0.2"

# Ubuntu 22.04 specific overrides for nginx
sources:
  - name: "main"
    prerequisites:
      - "build-essential"
      - "libssl-dev"
      - "libpcre3-dev"
      - "zlib1g-dev"
      - "wget"
      - "tar"
      - "libgd-dev"
      - "libgeoip-dev"
      - "libxslt1-dev"
    configure_args:
      - "--prefix=/usr/local"
      - "--sbin-path=/usr/local/sbin/nginx"
      - "--conf-path=/etc/nginx/nginx.conf"
      - "--error-log-path=/var/log/nginx/error.log"
      - "--http-log-path=/var/log/nginx/access.log"
      - "--pid-path=/var/run/nginx.pid"
      - "--lock-path=/var/run/nginx.lock"
      - "--http-client-body-temp-path=/var/cache/nginx/client_temp"
      - "--http-proxy-temp-path=/var/cache/nginx/proxy_temp"
      - "--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp"
      - "--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp"
      - "--http-scgi-temp-path=/var/cache/nginx/scgi_temp"
      - "--with-http_ssl_module"
      - "--with-http_v2_module"
      - "--with-http_gzip_static_module"
      - "--with-http_stub_status_module"
      - "--with-file-aio"
      - "--with-http_secure_link_module"
      - "--with-http_realip_module"
      - "--with-http_image_filter_module"
      - "--with-http_geoip_module"
      - "--with-http_xslt_module"
      - "--with-threads"
      - "--with-stream"
      - "--with-stream_ssl_module"
    environment:
      CC: "gcc-11"
      CXX: "g++-11"
      CFLAGS: "-O2 -g -pipe -fstack-protector-strong"
      LDFLAGS: "-Wl,-rpath,/usr/local/lib -Wl,-z,relro -Wl,-z,now"
    custom_commands:
      install: "make {{install_args | join(' ')}} && mkdir -p /etc/nginx /var/log/nginx /var/cache/nginx /var/cache/nginx/client_temp /var/cache/nginx/proxy_temp /var/cache/nginx/fastcgi_temp /var/cache/nginx/uwsgi_temp /var/cache/nginx/scgi_temp && adduser --system --no-create-home --disabled-login --disabled-password --group nginx && chown -R nginx:nginx /var/log/nginx /var/cache/nginx"

providers:
  source:
    sources:
      - name: "main"
        prerequisites:
          - "build-essential"
          - "libssl-dev"
          - "libpcre3-dev"
          - "zlib1g-dev"
          - "wget"
          - "tar"
          - "libgd-dev"
          - "libgeoip-dev"
          - "libxslt1-dev"
        environment:
          CC: "gcc-11"
          CXX: "g++-11"
          CFLAGS: "-O2 -g -pipe -fstack-protector-strong"
          LDFLAGS: "-Wl,-rpath,/usr/local/lib -Wl,-z,relro -Wl,-z,now"
        custom_commands:
          install: "make {{install_args | join(' ')}} && mkdir -p /etc/nginx /var/log/nginx /var/cache/nginx /var/cache/nginx/client_temp /var/cache/nginx/proxy_temp /var/cache/nginx/fastcgi_temp /var/cache/nginx/uwsgi_temp /var/cache/nginx/scgi_temp && adduser --system --no-create-home --disabled-login --disabled-password --group nginx && chown -R nginx:nginx /var/log/nginx /var/cache/nginx"